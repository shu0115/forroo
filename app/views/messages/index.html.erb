<script type="text/javascript">
  /* Pusher */
  var pusher = new Pusher('<%= Pusher.key %>'); // uses your API KEY
  var channel = pusher.subscribe('channel_room_<%= @room.id %>');

  channel.bind( 'message_event_room_<%= @room.id %>', function(result){
    $.get(
      // 送信先
      "/rooms/<%= @room.id %>/messages/list",
      // 送信データ
      null,
      // コールバック
      function(data, status) {
        $('#messages_target_room_<%= @room.id %>').html(data);
        // デスクトップ通知
        Notification.show( result.icon, result.title, result.message, 8000 );
      },
      // 応答データ形式
      "html"
    );
  });
</script>

<h3><%= link_to( @room.title, room_messages_path( @room ) ) %></h3>
<p><%= @room.permission %>：<%= @room.messages_count %></p>

<p><button id="notification" onClick="Notification.ask();">デスクトップ通知</button></p>

<%# 新規メッセージフォーム %>
<%= form_for( :message, url: room_messages_path ) do |f| %>
  <div class="field">
    <%= f.text_area :sentence, wrap: "off", class: "span8", rows: 5 %>
  </div>

  <div class="actions">
    <%= f.submit "投稿", data: { 'disable-with' => t( "menu.create" ) } %>
  </div>
<% end %>

<%# メッセージ一覧 %>
<div id="messages_target_room_<%= @room.id %>">
  <%= render partial: 'messages', locals: { room: @room, messages: @messages } %>
</div>

<br />
<br />

<%= link_to "Rooms", rooms_path %>
